# Fix: Callee-Save Register Offsets (20260205-225448)

## Issue Summary

Multiple csmith-generated programs crash with SIGSEGV (signal 11) or SIGBUS (signal 10). The root cause is **incorrect stack frame layout for callee-saved registers**.

## Affected Seeds

- 55976753 (runtime crash, signal 11)
- 114128045 (runtime crash, signal 11)  
- 3253220824 (runtime crash, signal 10)

## Root Cause

In `pkg/stacking/layout.go`, the `CalleeSaveOffset` is set to `+16` (a positive offset from FP). This is incorrect.

When FP is set to point at the saved FP/LR pair in the middle of the frame:
- Positive offsets from FP go UP into the caller's frame (invalid memory)
- Negative offsets from FP go DOWN into our allocated frame (correct)

### Example: func_1 with x19, x20 callee-saved

Current (broken) behavior:
```
sub  sp, sp, #32           ; allocate 32 bytes
stp  x29, x30, [sp, #16]   ; save FP/LR at sp+16
add  x29, sp, #16          ; FP = sp+16
str  x19, [x29, #16]       ; WRONG: stores at sp+32 (outside frame!)
str  x20, [x29, #24]       ; WRONG: stores at sp+40 (outside frame!)
```

The callee-save stores clobber memory above the stack frame, causing crashes.

### Correct Frame Layout

With FP pointing at saved FP/LR, the frame should be:
```
[SP + 32] ← old SP / caller's frame
[SP + 24] = saved LR        [FP + 8]
[SP + 16] = saved FP        [FP + 0] ← FP points here
[SP + 8]  = x20             [FP - 8]
[SP + 0]  = x19             [FP - 16]
          ← SP
```

Callee-saved registers should be at **negative** offsets from FP.

## Proposed Fix

In `pkg/stacking/layout.go`, change the callee-save offset calculation:

```go
// Current (wrong):
layout.CalleeSaveOffset = 16

// Should be (correct):
// Callee-saves start below FP at negative offsets
layout.CalleeSaveOffset = -layout.CalleeSaveSize
```

And update `calleesave.go` to use descending offsets:
```go
// Current: offset starts at +16 and increments
// Should: offset starts at -8 (first slot below FP) and decrements
offset := int64(-8)
for i := range usedRegs {
    info.SaveOffsets[i] = offset
    offset -= 8
}
```

## Files to Modify

1. `pkg/stacking/layout.go` - Fix CalleeSaveOffset calculation
2. `pkg/stacking/calleesave.go` - Fix offset assignment in ComputeCalleeSaveInfo
3. `pkg/stacking/layout_test.go` - Update tests for new expected values
4. `pkg/stacking/calleesave_test.go` - Update tests for negative offsets

## Verification

After fix, all four crash seeds should:
1. Compile without error
2. Run without crash
3. Produce correct output (matching gcc)

## Additional Notes

The output mismatch case (seed 263236830, gcc exit 125 vs ralph exit 0) may be a separate issue unrelated to stack layout - gcc returning 125 suggests a compile-time or linking error on gcc's side, or a different execution path.
