# Fix: crash_55976753 - Callee-Save Register Offset Sign Error

## Summary

Runtime crash (SIGSEGV/SIGBUS) caused by callee-saved registers being stored at positive offsets from FP, which places them outside the allocated stack frame.

## Symptom

Program crashes at runtime when functions use callee-saved registers (X19-X28).

## Root Cause

The stack frame layout (`pkg/stacking/layout.go`) computes positive offsets for callee-saved registers:

```go
// line 77
layout.CalleeSaveOffset = 16  // POSITIVE - should be NEGATIVE!
```

However, the frame layout diagram and comments correctly describe negative offsets:

```
//	| Callee-saved registers    |  negative offsets from FP
```

### Generated Assembly Example (from crash_55976753.c)

```asm
func_1:
    sub  sp, sp, #32          ; Allocate 32 bytes
    stp  x29, x30, [sp, #16]  ; Save FP/LR at SP+16
    add  x29, sp, #16         ; FP = SP+16
    str  x19, [x29, #16]      ; Store X19 at FP+16 = SP+32 = OUTSIDE FRAME!
    str  x20, [x29, #24]      ; Store X20 at FP+24 = SP+40 = OUTSIDE FRAME!
```

**Frame Size: 32 bytes (SP to SP+32)**  
**FP points to SP+16**  
**Callee-save stores at FP+16 and FP+24 = SP+32 and SP+40 = beyond frame!**

### Correct Layout

```
    Low addresses
        │                    │  
   SP → ├────────────────────┤
        │ outgoing args      │  SP+0
        │ locals             │
        │ callee-saves       │  negative from FP (inside frame)
        ├────────────────────┤
   FP → │ saved FP           │  FP+0
        │ saved LR           │  FP+8
        ├────────────────────┤
        │ caller's frame     │  FP+16 (incoming args here)
    High addresses
```

Callee-saved registers should be stored at **negative offsets** from FP (e.g., FP-8, FP-16, etc.), placing them between SP and FP.

## Fix Plan

Modify `pkg/stacking/layout.go` to use negative offsets for callee-saved registers:

### Option A: Fix CalleeSaveOffset (Recommended)

Change line 77 from:
```go
layout.CalleeSaveOffset = 16
```

To:
```go
// Callee-save registers at negative offsets from FP, immediately below FP/LR save area
layout.CalleeSaveOffset = -layout.CalleeSaveSize
```

Then update `LocalOffset` and `OutgoingOffset` to stack below that.

### Option B: Alternative Stack Layout

Rearrange the frame layout to put callee-saves in a different position while still using positive offsets. This is more complex and may require changes to prologue/epilogue generation.

## Files to Modify

1. `pkg/stacking/layout.go` - Fix offset calculation
2. `pkg/stacking/layout_test.go` - Update tests to expect negative offsets
3. Potentially `pkg/stacking/prolog.go` - Verify prologue/epilogue generation handles negative offsets

## Verification

After fix:
1. `crash_55976753.c` should compile and run without crashing
2. All other csmith crash tests with similar symptoms likely have the same root cause
3. Run `make test` to verify no regressions

## Related Issues

This is documented in COMMON_CAUSES.md as "Callee-Save Register Offset Sign Error (CONFIRMED)". This crash confirms the issue is real and provides a concrete failing test case.

Multiple other crashes in the PLAN.md (crash_785411410, crash_3051214201, etc.) likely have the same root cause.

## Notes

The layout comments are correct but the implementation is wrong. The frame diagram in the code says callee-saved registers should be at "negative offsets from FP" but the offset is computed as positive 16.
